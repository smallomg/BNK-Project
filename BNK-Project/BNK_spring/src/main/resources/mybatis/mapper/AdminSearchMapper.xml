<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busanbank.card.admin.dao.IAdminSearchDao">

	<!-- 검색어 로그 저장 -->
	<insert id="insertSearchLog"
		parameterType="com.busanbank.card.admin.dto.SearchLogDto">
		INSERT INTO SEARCH_LOG (
		SEARCH_LOG_NO,
		MEMBER_NO,
		KEYWORD,
		IS_PROHIBITED,
		IS_RECOMMENDED,
		SEARCH_DATE
		) VALUES (
		SEARCH_LOG_SEQ.NEXTVAL,
		  #{memberNo, jdbcType=NUMERIC},
		#{keyword},
		#{isProhibited},
		#{isRecommended},
		SYSDATE
		)
	</insert>

	<!-- 금칙어 여부 -->
	<select id="isProhibitedKeyword" resultType="int">
		SELECT COUNT(*)
		FROM
		PROHIBITED_WORD
		WHERE KEYWORD = #{keyword}
	</select>

	<!-- 추천어 여부 -->
	<select id="isRecommendedKeyword" resultType="int">
		SELECT COUNT(*)
		FROM RECOMMENDED_WORD
		WHERE KEYWORD = #{keyword}
	</select>



	<!-- 추천어 목록 -->
	<select id="getRecommendedWords" resultType="map">
		SELECT
		RECOMMENDED_NO, KEYWORD, REG_DATE
		FROM RECOMMENDED_WORD
		ORDER BY
		REG_DATE DESC
	</select>

	<!-- 금칙어 목록 -->
	<select id="getProhibitedWords" resultType="map">
		SELECT PROHIBITED_NO,
		KEYWORD, REG_DATE
		FROM PROHIBITED_WORD
		ORDER BY REG_DATE DESC
	</select>

	<!-- 인기 검색어 TOP 10 -->
	<select id="getTopKeywords" resultType="map">
		SELECT KEYWORD, COUNT(*)
		AS CNT
		FROM SEARCH_LOG
		WHERE IS_PROHIBITED = 'N'
		GROUP BY KEYWORD
		ORDER BY
		CNT DESC
		FETCH FIRST 10 ROWS ONLY
	</select>



	<!-- 추천어 등록 -->
	<insert id="insertRecommended">
		INSERT INTO RECOMMENDED_WORD (
		RECOMMENDED_NO,
		KEYWORD,
		REG_DATE
		) VALUES (
		RECOMMENDED_WORD_SEQ.NEXTVAL,
		#{keyword},
		SYSDATE
		)
	</insert>

	<!-- 추천어 수정 -->
	<update id="updateRecommended">
		UPDATE RECOMMENDED_WORD
		SET KEYWORD = #{keyword}
		WHERE
		RECOMMENDED_NO = #{id}
	</update>

	<!-- 추천어 삭제 -->
	<delete id="deleteRecommended">
		DELETE FROM RECOMMENDED_WORD
		WHERE RECOMMENDED_NO =
		#{id}
	</delete>

	<!-- 금칙어 등록 -->
	<insert id="insertProhibited">
		INSERT INTO PROHIBITED_WORD (
		PROHIBITED_NO,
		KEYWORD,
		REG_DATE
		) VALUES (
		PROHIBITED_WORD_SEQ.NEXTVAL,
		#{keyword},
		SYSDATE
		)
	</insert>

	<!-- 금칙어 수정 -->
	<update id="updateProhibited">
		UPDATE PROHIBITED_WORD
		SET KEYWORD = #{keyword}
		WHERE
		PROHIBITED_NO = #{id}
	</update>

	<!-- 금칙어 삭제 -->
	<delete id="deleteProhibited">
		DELETE FROM PROHIBITED_WORD
		WHERE PROHIBITED_NO =
		#{id}
	</delete>

	<!-- 기간별 검색 로그 조회 -->
	<select id="getSearchLogsByPeriod" resultType="map">
		SELECT
		SEARCH_LOG_NO,
		MEMBER_NO,
		KEYWORD,
		IS_PROHIBITED,
		IS_RECOMMENDED,
		SEARCH_DATE
		FROM
		SEARCH_LOG
		<where>
			<if test="from != null and from != ''">
				SEARCH_DATE &gt;= TO_DATE(#{from}, 'YYYY-MM-DD')
			</if>
			<if test="to != null and to != ''">
				AND SEARCH_DATE &lt;= TO_DATE(#{to}, 'YYYY-MM-DD') + 1 - (1/86400)
			</if>
		</where>
		ORDER BY
		SEARCH_DATE DESC
		OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>

	<!-- 총 개수 조회 -->
	<select id="getSearchLogsCount" resultType="int">
		SELECT COUNT(*)
		FROM SEARCH_LOG
		<where>
			<if test="from != null and from != ''">
				SEARCH_DATE &gt;= TO_DATE(#{from}, 'YYYY-MM-DD')
			</if>
			<if test="to != null and to != ''">
				AND SEARCH_DATE &lt;= TO_DATE(#{to}, 'YYYY-MM-DD') + 1 - (1/86400)
			</if>
		</where>
	</select>



</mapper>