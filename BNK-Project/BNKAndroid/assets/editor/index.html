<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì»¤ìŠ¤í…€ ì¹´ë“œ ì—ë””í„°</title>
    <style>
        *{
            margin:0;
            padding:0;
        }
      body {
        font-family: sans-serif;
      }

      .card {
        width: 250px;
        aspect-ratio: 3 / 5;
        background-size: 100%;
        background-repeat: no-repeat;
        background-position: 50% 50%;

        border: 1px solid #ccc;
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        touch-action: none; /* ëª¨ë°”ì¼ í„°ì¹˜ ë°©ì§€ */
        user-select: none;
        cursor: grab;
      }


      .text-box {
          touch-action: none;
        position: absolute;
        font-size: 20px;
        color: black;
        font-weight: bold;
        cursor: move;
        user-select: none;
        transform: translate(0px, 0px);
      }

      .close-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        background: red;
        color: white;
        border-radius: 50%;
        padding: 2px 5px;
        cursor: pointer;
        font-size: 14px;
        z-index: 10;
      }
      .rotate-btn {
          position: absolute;
          top: -10px;
          left: -10px;
          background: #555;
          color: white;
          border-radius: 50%;
          padding: 2px 5px;
          cursor: grab;
          font-size: 12px;
          z-index: 10;
          user-select: none;
        }
    #bgImg {
        position: absolute;
        top: 0;
        left: 0;
        transform-origin: center center;
        object-fit: cover;
        pointer-events: none; /* ë“œë˜ê·¸ ì´ë²¤íŠ¸ê°€ í…ìŠ¤íŠ¸ ë“±ì—ë§Œ ì „ë‹¬ë˜ë„ë¡ */
        height: 100%;
      }

      #emojiListContainer {
        position: fixed;
        bottom: 0px;
        left: 0;
        right: 0;
        background: #f0f0f0;
        padding: 10px 0;
        overflow-x: auto;
        white-space: nowrap;
        display: none;
        border-top: 1px solid #ccc;
        z-index: 20;
      }

      #emojiList {
        display: inline-block;
        padding: 0 20px;
      }

      .emoji {
        display: inline-block;
        font-size: 24px;
        margin: 0 10px;
        cursor: pointer;
        user-select: none;
      }

    #fontListContainer {
      position: fixed;
      bottom: 0px;
      left: 0;
      right: 0;
      background: #f8f8f8;
      padding: 8px 0;
      overflow-x: auto;
      white-space: nowrap;
      display: none;
      border-top: 1px solid #ccc;
      z-index: 20;
    }
    #fontList {
      display: inline-block;
      padding: 0 20px;
    }
    .font-option {
      display: inline-block;
      font-size: 16px;
      margin: 0 10px;
      padding: 4px 8px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</head>
<body>
<button id="addTextBtn">í…ìŠ¤íŠ¸ ì¶”ê°€</button>
<button id="increaseFont">A+</button>
<button id="decreaseFont">A-</button>
<button id="toggleFontList">ğŸ”¤ í°íŠ¸</button>
<label>T<input type="color" id="fontColorPicker" value="#000000"></label>
<input type="file" id="cardBgInput" accept="image/*" />
<label>ë°°ê²½<input type="color" id="cardBgColorPicker" value="#ffffff" /></label>
<button id="zoomIn">í™•ëŒ€</button>
<button id="zoomOut">ì¶•ì†Œ</button>
<button id="reset">ì´ˆê¸°í™”</button>
<label>íšŒì „: <input type="range" id="rotateRange" min="-180" max="180" value="0" /></label>
<button id="toggleEmojiList">ğŸ˜Š ì´ëª¨í‹°ì½˜</button>
<button id="saveBtn">ì¹´ë“œ ì €ì¥</button>


<div id="emojiListContainer">
    <div id="emojiList">
        <span class="emoji">ğŸ˜€</span>
        <span class="emoji">ğŸ˜‚</span>
        <span class="emoji">ğŸ˜</span>
        <span class="emoji">ğŸ‘</span>
        <span class="emoji">ğŸ”¥</span>
        <span class="emoji">ğŸ‰</span>
        <span class="emoji">ğŸ’–</span>
        <span class="emoji">ğŸ±</span>
        <span class="emoji">ğŸŒˆ</span>
        <!-- í•„ìš” ì‹œ ë” ì¶”ê°€ -->
    </div>
</div>

<div id="fontListContainer">
    <div id="fontList">
        <span class="font-option" data-font="sans-serif" style="font-family: sans-serif">ê¸°ë³¸</span>
        <span class="font-option" data-font="serif" style="font-family: serif">Serif</span>
        <span class="font-option" data-font="monospace" style="font-family: monospace">Mono</span>
        <span class="font-option" data-font="'Courier New'" style="font-family: 'Courier New'">Courier</span>
        <span class="font-option" data-font="'Comic Sans MS'" style="font-family: 'Comic Sans MS'">Comic</span>
        <span class="font-option" data-font="'Times New Roman'" style="font-family: 'Times New Roman'">Times</span>
        <!-- í•„ìš”ì‹œ ë” ì¶”ê°€ -->
    </div>
</div>

<div class="card" id="card">
    <img id="bgImg" />
</div>

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
    let count = 0;
    let selectedTextBox = null;
    let bgRotate = 0; // ë°°ê²½ íšŒì „ê°
    let bgScale = 1;

    document.getElementById('addTextBtn').addEventListener('click', () => {
      const card = document.getElementById('card');
      const newText = document.createElement('div');

      newText.className = 'text-box';
      newText.innerText = 'ìƒˆ í…ìŠ¤íŠ¸ ' + (++count);
      newText.setAttribute('data-x', 0);
      newText.setAttribute('data-y', 0);
      newText.setAttribute('data-rotate', 0);
      newText.style.transform = 'translate(0px, 0px) rotate(0deg)';
      card.appendChild(newText);

      makeDraggable(newText);
      enableEditing(newText);
      enableTextBoxInteraction(newText);
    });

    function makeDraggable(target) {
        touchAction: 'none',
      interact(target).draggable({
        listeners: {
          move(event) {
            const target = event.target;
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
            const angle = parseFloat(target.getAttribute('data-rotate')) || 0;

            target.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
          }
        }
      });
    }

    function enableEditing(textBox) {
        let touchTimer = null;

        // ëª¨ë°”ì¼: ê¸¸ê²Œ ëˆ„ë¥´ë©´ ìˆ˜ì •ëª¨ë“œ
        textBox.addEventListener('touchstart', () => {
          touchTimer = setTimeout(() => {
            textBox.setAttribute('contenteditable', 'true');
            textBox.focus();
          }, 500); // 500ms ì´ìƒ ëˆ„ë¥´ë©´ ìˆ˜ì • ëª¨ë“œ
        });

        textBox.addEventListener('touchend', () => {
          clearTimeout(touchTimer);
        });

        // ë°ìŠ¤í¬íƒ‘: ë”ë¸”í´ë¦­
        textBox.addEventListener('dblclick', () => {
          textBox.setAttribute('contenteditable', 'true');
          textBox.focus();
        });

        // í¬ì»¤ìŠ¤ ìƒì—ˆì„ ë•Œ ì €ì¥
        textBox.addEventListener('blur', () => {
          textBox.removeAttribute('contenteditable');
        });
      }

    function enableTextBoxInteraction(textBox) {
      textBox.addEventListener('click', (e) => {

        e.stopPropagation();
        selectedTextBox = textBox;

        // ê¸°ì¡´ ë²„íŠ¼ ì œê±°
        document.querySelectorAll('.text-box .close-btn').forEach(btn => btn.remove());
        document.querySelectorAll('.text-box .rotate-btn').forEach(btn => btn.remove());

        // X ë²„íŠ¼ ìƒì„±
        const closeBtn = document.createElement('span');
        closeBtn.innerText = 'Ã—';
        closeBtn.className = 'close-btn';
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          textBox.remove();
          selectedTextBox = null;
        });
        textBox.appendChild(closeBtn);

        // íšŒì „ ë²„íŠ¼ ìƒì„±
        const rotateBtn = document.createElement('span');
        rotateBtn.innerText = 'âŸ³';
        rotateBtn.className = 'rotate-btn';
        textBox.appendChild(rotateBtn);


        let isRotating = false;
        let startAngle = 0;
        let baseRotate = 0;

        rotateBtn.addEventListener('pointerdown', (e) => {
          e.stopPropagation();
          e.preventDefault();
          isRotating = true;

          const rect = textBox.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;

          const x = parseFloat(textBox.getAttribute('data-x')) || 0;
          const y = parseFloat(textBox.getAttribute('data-y')) || 0;
          baseRotate = parseFloat(textBox.getAttribute('data-rotate')) || 0;

          const dx = e.clientX - centerX;
          const dy = e.clientY - centerY;
          startAngle = Math.atan2(dy, dx) * (180 / Math.PI);

          function onPointerMove(eMove) {
            if (!isRotating) return;
            const dx2 = eMove.clientX - centerX;
            const dy2 = eMove.clientY - centerY;
            const currentAngle = Math.atan2(dy2, dx2) * (180 / Math.PI);
            const angleDiff = currentAngle - startAngle;
            const newAngle = baseRotate + angleDiff;

            textBox.style.transform = `translate(${x}px, ${y}px) rotate(${newAngle}deg)`;
            textBox.setAttribute('data-rotate', newAngle);
          }

          function onPointerUp() {
            isRotating = false;
            window.removeEventListener('pointermove', onPointerMove);
            window.removeEventListener('pointerup', onPointerUp);
          }

          window.addEventListener('pointermove', onPointerMove);
          window.addEventListener('pointerup', onPointerUp);
        });
      });
    }

    // ì¹´ë“œ ì˜ì—­ í´ë¦­ ì‹œ ëª¨ë“  ë²„íŠ¼ ì œê±°
    document.getElementById('card').addEventListener('click', () => {
      document.querySelectorAll('.text-box .close-btn').forEach(btn => btn.remove());
      document.querySelectorAll('.text-box .rotate-btn').forEach(btn => btn.remove());
      selectedTextBox = null;
    });

    // í°íŠ¸ í¬ê¸° ì¦ê°€
    document.getElementById('increaseFont').addEventListener('click', () => {
      if (selectedTextBox) {
        const currentSize = parseInt(window.getComputedStyle(selectedTextBox).fontSize);
        selectedTextBox.style.fontSize = (currentSize + 2) + 'px';
      }
    });

    // í°íŠ¸ í¬ê¸° ê°ì†Œ
    document.getElementById('decreaseFont').addEventListener('click', () => {
      if (selectedTextBox) {
        const currentSize = parseInt(window.getComputedStyle(selectedTextBox).fontSize);
        selectedTextBox.style.fontSize = Math.max(10, currentSize - 2) + 'px';
      }
    });
    //ê¸€ì ìƒ‰ìƒ ë³€ê²½
    document.getElementById('fontColorPicker').addEventListener('input', (e) => {
      if (selectedTextBox) {
            selectedTextBox.style.color = e.target.value;
      }
    });

    //ë°°ê²½ì´ë¯¸ì§€ ì‚½ì…
    document.getElementById('cardBgInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          const bgUrl = event.target.result;
        };
        reader.readAsDataURL(file);
      });

    //ë°°ê²½ ì´ë¯¸ì§€ ìœ„ì¹˜ì¡°ì •
    const card = document.getElementById('card');
  const fileInput = document.getElementById('cardBgInput');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const resetBtn = document.getElementById('reset');

  let bgPos = { x: 0, y: 0 }; // ì´ˆê¸° background-position
  let bgSize = 100; // ì´ˆê¸° background-size (%)
  let isDragging = false;
  let start = { x: 0, y: 0 };

  // ì´ë¯¸ì§€ ì—…ë¡œë“œ
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        document.getElementById('bgImg').src = event.target.result;
          // ì¶”ê°€: ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì´ˆê¸°í™”
          bgPos = { x: 0, y: 0 };
          bgScale = 1;
          bgRotate = 0;
          rotateRange.value = 0;
          updateBgTransform();
    };
    reader.readAsDataURL(file);
  });

  // ë“œë˜ê·¸ ì‹œì‘
  card.addEventListener('mousedown', (e) => {
      if (e.target.closest('.text-box')) return;
    isDragging = true;
    start.x = e.clientX;
    start.y = e.clientY;
    card.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    const dx = e.clientX - start.x;
    const dy = e.clientY - start.y;

    bgPos.x += dx / card.offsetWidth * 100;
    bgPos.y += dy / card.offsetHeight * 100;


    updateBgTransform();

    start.x = e.clientX;
    start.y = e.clientY;
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    card.style.cursor = 'grab';
  });

  // í™•ëŒ€/ì¶•ì†Œ
  zoomInBtn.addEventListener('pointerup', () => {
    bgScale = Math.min(3, bgScale + 0.1);
    updateBgTransform();
  });

  zoomOutBtn.addEventListener('pointerup', () => {
    bgScale = Math.max(0.3, bgScale - 0.1);
    updateBgTransform();
  });

  // ì´ˆê¸°í™”
  resetBtn.addEventListener('click', () => {
    bgPos = { x: 0, y: 0 };
    bgSize = 100;
    updateBgTransform();
    document.getElementById('card').style.backgroundColor = '#ffffff'; // ë°°ê²½ìƒ‰ì´ˆê¸°ê°’
    document.getElementById('cardBgColorPicker').value = '#ffffff'; // ì»¬ëŸ¬í”¼ì»¤ë„ ì´ˆê¸°í™”
  });

  // ì ìš© í•¨ìˆ˜
  function updateBgTransform() {
    bgImg.style.transform = `
      translate(${bgPos.x}px, ${bgPos.y}px)
      scale(${bgScale})
      rotate(${bgRotate}deg)
    `;
  }

  //ëª¨ë°”ì¼ í„°ì¹˜ ì‹œì‘
  card.addEventListener('touchstart', (e) => {
      if (e.target.closest('.text-box')) return; // í…ìŠ¤íŠ¸ë°•ìŠ¤ í„°ì¹˜ë©´ ë°°ê²½ ë“œë˜ê·¸ ë¬´ì‹œ
    if (e.touches.length !== 1) return; // ë©€í‹°í„°ì¹˜ ë°©ì§€
    isDragging = true;
    start.x = e.touches[0].clientX;
    start.y = e.touches[0].clientY;
    card.style.cursor = 'grabbing';
  }, { passive: false });

  // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë™
  document.addEventListener('touchmove', (e) => {
    if (!isDragging || e.touches.length !== 1) return;

    const dx = e.touches[0].clientX - start.x;
    const dy = e.touches[0].clientY - start.y;

    bgPos.x += dx / card.offsetWidth * 100;
    bgPos.y += dy / card.offsetHeight * 100;


    updateBgTransform();

    start.x = e.touches[0].clientX;
    start.y = e.touches[0].clientY;
  }, { passive: false });

  // ëª¨ë°”ì¼ í„°ì¹˜ ë
  document.addEventListener('touchend', () => {
    isDragging = false;
    card.style.cursor = 'grab';
  });
  //ì´ë¯¸ì§€íšŒì „
  const rotateRange = document.getElementById('rotateRange');

  rotateRange.addEventListener('input', (e) => {
    bgRotate = parseInt(e.target.value, 10);
    updateBgTransform();
  });

  resetBtn.addEventListener('click', () => {
        bgPos = { x: 0, y: 0 };
        bgSize = 100;
        bgRotate = 0;
        rotateRange.value = 0; // ìŠ¬ë¼ì´ë”ë„ ì´ˆê¸°í™”
        updateBgTransform();
      });

  //ë°°ê²½ìƒ‰ ë³€ê²½
  document.getElementById('cardBgColorPicker').addEventListener('input', (e) => {
    document.getElementById('card').style.backgroundColor = e.target.value;
  });


  //ì´ëª¨í‹°ì½˜ ëª©ë¡ í† ê¸€
  document.getElementById('toggleEmojiList').addEventListener('click', () => {
    const list = document.getElementById('emojiListContainer');
    const fontlist = document.getElementById('fontListContainer');
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
    fontlist.style.display = 'none';
  });

  // ì´ëª¨í‹°ì½˜ í´ë¦­ ì‹œ ì¹´ë“œì— ì¶”ê°€
  document.querySelectorAll('#emojiList .emoji').forEach(emojiEl => {
    emojiEl.addEventListener('click', () => {
      const card = document.getElementById('card');
      const newEmoji = document.createElement('div');

      newEmoji.className = 'text-box';
      newEmoji.innerText = emojiEl.innerText;
      newEmoji.setAttribute('data-x', 0);
      newEmoji.setAttribute('data-y', 0);
      newEmoji.setAttribute('data-rotate', 0);
      newEmoji.style.transform = 'translate(0px, 0px) rotate(0deg)';
      card.appendChild(newEmoji);

      makeDraggable(newEmoji);
      enableTextBoxInteraction(newEmoji);
    });
  });

  //í°íŠ¸ ëª©ë¡ í† ê¸€
  document.getElementById('toggleFontList').addEventListener('click', () => {
    const list = document.getElementById('fontListContainer');
    const emojilist = document.getElementById('emojiListContainer');
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
    emojilist.style.display = 'none';
  });

  // í°íŠ¸ í´ë¦­ ì‹œ í…ìŠ¤íŠ¸ ë°•ìŠ¤ì— ì ìš©
  document.querySelectorAll('.font-option').forEach(fontEl => {
    fontEl.addEventListener('click', () => {
      if (selectedTextBox) {
        selectedTextBox.style.fontFamily = fontEl.getAttribute('data-font');
      }
    });
  });

  //ì¹´ë“œ ì´ë¯¸ì§€ë¡œ ì €ì¥
  document.getElementById('saveBtn').addEventListener('click', () => {
      const card = document.getElementById('card'); // ì¹´ë“œ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ìš”ì†Œ ID

      html2canvas(card).then(canvas => {
        const link = document.createElement('a');
        link.download = 'custom_card.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    });
</script>


</body>
</html>
